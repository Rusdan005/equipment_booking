<?php

namespace App\Http\Controllers;

use App\Models\Booking;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class ManageBookingController extends Controller
{
    /**
     * ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
     */
    public function __construct()
    {
        $this->middleware(['auth']);
    }

    // ----------------------------------------------------------------------
    // üìù ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 : ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (Review)
    // ----------------------------------------------------------------------

    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ (status = pending)
     */
    public function reviewIndex()
    {
        $this->authorize('manage-bookings'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå

        $bookings = Booking::with(['user', 'equipment'])
            ->where('status', 'pending')
            ->latest()
            ->paginate(10);

        return view('bookings.review-index', compact('bookings'));
    }

    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
     */
    public function reviewShow(Booking $booking)
    {
        $this->authorize('manage-bookings');

        $booking->load(['user', 'equipment']);
        return view('bookings.review-show', compact('booking'));
    }

    /**
     * ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠
     */
    public function approve(Booking $booking)
    {
        $this->authorize('manage-bookings');

        if ($booking->status !== 'pending') {
            return back()->with('error', '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
        }

        $booking->update([
            'status' => 'approved',
            'approved_by' => Auth::id(),
            'approved_at' => now(),
            'pickup_code' => $booking->pickup_code ?? strtoupper(str()->random(6)),
        ]);

        return redirect()->route('manage.bookings.review.index')
            ->with('success', '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }

    /**
     * ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠
     */
    public function reject(Booking $booking, Request $request)
    {
        $this->authorize('manage-bookings');

        $request->validate([
            'reject_reason' => 'required|string|min:3'
        ]);

        if ($booking->status !== 'pending') {
            return back()->with('error', '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
        }

        $booking->update([
            'status' => 'rejected',
            'approved_by' => Auth::id(),
            'approved_at' => now(),
            'reject_reason' => $request->reject_reason,
        ]);

        return redirect()->route('manage.bookings.review.index')
            ->with('success', '‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ----------------------------------------------------------------------
    // üì¶ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 : ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Pickup)
    // ----------------------------------------------------------------------

    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö
     */
    public function pickupIndex(Request $request)
    {
        $this->authorize('manage-bookings');

        $query = Booking::with(['user', 'equipment'])
            ->where('status', 'approved')
            ->whereNull('picked_up_at')
            ->latest();

        if ($request->filled('code')) {
            $query->where('pickup_code', $request->code);
        }

        $bookings = $query->paginate(10);

        return view('bookings.pickup-index', compact('bookings'));
    }

    /**
     * ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß
     */
    public function pickup(Booking $booking)
    {
        $this->authorize('manage-bookings');

        if ($booking->status !== 'approved') {
            return back()->with('error', '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ');
        }

        $booking->update([
            'status' => 'picked_up',
            'picked_up_by' => Auth::id(),
            'picked_up_at' => now(),
        ]);

        return redirect()->route('manage.bookings.pickup.index')
            ->with('success', 'üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }
}
